import{i as ve,av as ke,aw as be,n as V,j as ge,a7 as ye,_ as _e,u as Te,ax as we,r as h,X as Ae,ay as he,o as xe,I as Ce,p as Ve,e as c,k as T,q as a,h as l,f as v,g as u,t as k,Q as p,F as M,B as P,y,T as Qe,S as qe,A as le,C as F,H as Ie}from"./index-Y1q3RxoI.js";import{Q as j}from"./QInput-BgeGfsyL.js";import{u as $e,Q as Se,C as Le,f as C}from"./ContainerComp-BGVb6Dm6.js";import{Q as H}from"./QCard-DkCrdsLW.js";import{Q as W,a as Ue}from"./QChip-Dx7n9bF0.js";import{Q as z,a as w}from"./QItem-BYZ5MaxK.js";import{Q as A}from"./QItemLabel-B8jZg-I0.js";import{Q as J}from"./QList-B4bk0qsK.js";import{Q as $}from"./QCardSection-DfsUyDgB.js";import{Q as se}from"./QDialog-utyf43dy.js";import{Q as De}from"./QPage-DMtKAsPQ.js";import{C as O}from"./ClosePopup-CROo6fiG.js";import{u as Ne}from"./use-quasar-D9aSB_kD.js";import"./use-id-eM9t2YxV.js";import"./use-timeout-CmHpihJi.js";import"./use-dark-ekWLNdeH.js";import"./private.use-form-CfHLuyLw.js";import"./QBtnDropdown-uuIA0cLX.js";import"./QBtnGroup-Iuvdmsyo.js";import"./QTooltip-vNzE1vg4.js";import"./use-fullscreen-0wHJKqCh.js";import"./use-prevent-scroll-BguVKd-5.js";const oe=ve({name:"QCardActions",props:{...ke,vertical:Boolean},setup(S,{slots:r}){const Q=be(S),_=V(()=>`q-card__actions ${Q.value} q-card__actions--${S.vertical===!0?"vert column":"horiz row"}`);return()=>ge("div",{class:_.value},ye(r.default))}}),Be={key:0},Ee={class:"row justify-between items-center q-mb-md"},Re={key:0},Me={class:"row justify-end q-mt-md"},Pe={key:1},Fe={class:"row items-center justify-between"},je={class:"q-mb-md q-mt-md"},He={class:"text-caption"},We=["innerHTML"],ze={key:2,class:"text-center q-pa-lg"},Je={key:1},Oe={class:"row justify-between items-center q-mb-md"},Xe={key:0,class:"q-mt-xs"},Ge={key:1,class:"text-center q-pa-lg"},Ke={key:3,class:"text-center q-pa-lg"},Ye={__name:"TodoPage",setup(S){const r=$e(),Q=Te(),_=we(),L=Ne(),{apiAuth:ae}=Ie(),x=h(!1),g=h(""),U=h(!1),D=h(!1),q=h(null),b=h(!1),f=Ae({title:"",description:"",content:""}),ne=V(()=>!!_.params.id),m=V(()=>_.params.id?r.value.find(s=>s.createdAt.toString()===_.params.id):null),X=V(()=>r.value.filter(s=>!s.completed)),G=V(()=>r.value.filter(s=>s.completed)),N=s=>{Q.push(`/site/todo/${s}`)},B=()=>{if(b.value){if(!confirm("有未保存的更改，確定要離開嗎？"))return;b.value=!1}Q.push("/site/todo")},ie=()=>{m.value&&(f.title=m.value.title,f.description=m.value.description,f.content=m.value.content,b.value=!0)},re=()=>{b.value=!1},de=()=>{if(!m.value)return;const s=r.value.findIndex(e=>e.createdAt.toString()===_.params.id);s!==-1&&(r.value[s]={...r.value[s],title:f.title,description:f.description,content:f.content,updatedAt:C(Date.now())},b.value=!1)},ue=()=>{if(m.value&&confirm("確定要刪除這個待辦事項嗎？")){const s=r.value.findIndex(e=>e.createdAt.toString()===_.params.id);s!==-1&&(r.value.splice(s,1),B())}},K=s=>{const e=r.value.findIndex(d=>d.createdAt===s.createdAt);e!==-1&&(r.value[e]={...r.value[e],completed:!0,completedAt:C(Date.now())},q.value=s.createdAt,D.value=!0)},Y=s=>{const e=r.value.findIndex(d=>d.createdAt===s.createdAt);e!==-1&&(r.value[e]={...r.value[e],completed:!1,completedAt:null,inFlow:!1})},ce=()=>{if(!q.value)return;const s=r.value.findIndex(e=>e.createdAt===q.value);s!==-1&&(r.value[s]={...r.value[s],inFlow:!0}),q.value=null},me=async()=>{if(g.value.trim()){U.value=!0;try{const s=g.value.trim(),{data:e}=await ae.post("/api/ai/analyze-tasks",{text:s});if(!e.success)throw new Error(e.message||"處理失敗");const d=e.result;let t;try{t=JSON.parse(d)}catch(n){return console.error("AI 返回的不是有效 JSON:",d,n),Z(s)}const o=Date.now();for(let n=0;n<t.length;n++){const i=t[n];i.subTasks&&i.subTasks.length>0&&(i.subTasks=i.subTasks.map(E=>({id:E.id||`${o}-${n}-${Math.random().toString(36).substring(2,9)}`,title:E.title,completed:!1}))),r.value.unshift({title:i.title,description:i.description||"",content:i.description||"",createdAt:o-n,updatedAt:C(o),completed:!1,subTasks:i.subTasks||[],order:n})}x.value=!1,g.value="",L.notify({color:"positive",message:"成功創建待辦事項",icon:"check"})}catch(s){console.error("AI 處理失敗:",s),L.notify({type:"negative",message:"無法處理待辦事項："+(s.response?.data?.message||s.message),position:"top"}),Z(g.value)}finally{U.value=!1}}},Z=s=>{const e=s.split(`
`).filter(n=>n.trim()),d=Date.now(),t=[];let o=null;for(let n=0;n<e.length;n++){const i=e[n].trim();if(!i)continue;if((i.startsWith("  ")||i.startsWith("	")||i.startsWith("- ")||i.startsWith("* ")||/^\d+\.\s/.test(i))&&o){const I=i.replace(/^[\s\t]+/,"").replace(/^[-*]\s+/,"").replace(/^\d+\.\s+/,"");o.subTasks||(o.subTasks=[]),o.subTasks.push({id:`${d}-${n}-${Math.random().toString(36).substring(2,9)}`,title:I,completed:!1})}else{let I=i,R="";if(i.includes(":")){const te=i.split(":");I=te[0].trim(),R=te.slice(1).join(":").trim()}o={title:I,description:R,content:R,createdAt:d-n,updatedAt:C(d),completed:!1,subTasks:[]},t.push(o)}}t.forEach((n,i)=>{r.value.unshift({...n,order:i})}),x.value=!1,g.value=""};he((s,e,d)=>{b.value?confirm("有未保存的更改，確定要離開嗎？")?(b.value=!1,d()):d(!1):d()});const ee=s=>{if(b.value){const e="有未保存的更改，確定要離開嗎？";return s.returnValue=e,e}};xe(()=>{window.addEventListener("beforeunload",ee)}),Ce(()=>{window.removeEventListener("beforeunload",ee)});const pe=(s,e)=>{const d=r.value.findIndex(i=>i.createdAt===s);if(d===-1)return;const t=r.value[d];if(!t.subTasks)return;const o=t.subTasks.findIndex(i=>i.id===e);if(o===-1)return;t.subTasks[o].completed=!t.subTasks[o].completed;const n=t.subTasks.every(i=>i.completed);n&&!t.completed?K(t):!n&&t.completed&&Y(t)},fe=s=>{try{const e=JSON.parse(s.outputResult),d=Date.now();for(let t=0;t<e.length;t++){const o=e[t];o.subTasks&&o.subTasks.length>0&&(o.subTasks=o.subTasks.map(n=>({id:n.id||`${d}-${t}-${Math.random().toString(36).substring(2,9)}`,title:n.title,completed:!1}))),r.value.unshift({title:o.title,description:o.description||"",content:o.description||"",createdAt:d-t,updatedAt:C(d),completed:!1,subTasks:o.subTasks||[],order:t})}}catch(e){console.error("處理歷史記錄失敗:",e),L.notify({color:"negative",message:"無法使用此記錄",icon:"error"})}};return(s,e)=>{const d=Ve("AIHistoryList");return c(),T(De,{padding:""},{default:a(()=>[l(Le,null,{default:a(()=>[ne.value?(c(),v("div",Be,[u("div",Ee,[u("h3",null,k(m.value?.title||"待辦詳情"),1),l(p,{color:"primary",icon:"arrow_back",label:"返回",onClick:B})]),b.value&&m.value?(c(),v("div",Re,[l(j,{class:"q-mb-md",modelValue:f.title,"onUpdate:modelValue":e[0]||(e[0]=t=>f.title=t),label:"標題",outlined:""},null,8,["modelValue"]),l(j,{class:"q-mb-md",modelValue:f.description,"onUpdate:modelValue":e[1]||(e[1]=t=>f.description=t),label:"描述",outlined:""},null,8,["modelValue"]),l(H,{flat:"",bordered:"",class:"q-mt-sm"},{default:a(()=>[l(Se,{modelValue:f.content,"onUpdate:modelValue":e[2]||(e[2]=t=>f.content=t),"min-height":"5rem"},null,8,["modelValue"])]),_:1}),u("div",Me,[l(p,{color:"grey",label:"取消",onClick:re,class:"q-mr-sm"}),l(p,{color:"primary",label:"保存",onClick:de})])])):m.value?(c(),v("div",Pe,[u("div",Fe,[u("h3",je,k(m.value.title),1),u("div",null,[l(p,{round:"",color:"secondary",icon:"edit",onClick:ie}),l(p,{class:"q-ml-sm",round:"",color:"red",icon:"delete",onClick:ue})])]),u("div",null,k(m.value.description),1),u("div",He,"更新時間："+k(m.value.updatedAt),1),u("div",{class:"q-mt-md",innerHTML:m.value.content},null,8,We)])):(c(),v("div",ze,[e[8]||(e[8]=u("p",null,"找不到對應的待辦事項",-1)),l(p,{color:"primary",label:"返回列表",onClick:B})]))])):(c(),v("div",Je,[u("div",Oe,[e[9]||(e[9]=u("h3",null,"我的待辦事項",-1)),u("div",null,[l(p,{color:"primary",icon:"add",label:"新增待辦",to:"/site/todo-new",class:"q-mr-sm"}),l(p,{color:"secondary",icon:"text_snippet",label:"批量輸入",onClick:e[3]||(e[3]=t=>x.value=!0)})])]),u("div",null,[e[13]||(e[13]=u("h5",{class:"q-my-md"},"進行中的事項",-1)),X.value.length>0?(c(),T(J,{key:0,separator:""},{default:a(()=>[(c(!0),v(M,null,P(X.value,t=>(c(),T(z,{key:t.id,clickable:""},{default:a(()=>[l(w,{avatar:""},{default:a(()=>[l(W,{modelValue:t.completed,"onUpdate:modelValue":[o=>t.completed=o,o=>K(t)]},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(w,{onClick:o=>N(t.createdAt)},{default:a(()=>[l(A,null,{default:a(()=>[y(k(t.title),1)]),_:2},1024),l(A,{caption:""},{default:a(()=>[y(k(t.description),1)]),_:2},1024),l(A,{caption:""},{default:a(()=>[y(k(t.updatedAt),1)]),_:2},1024),t.subTasks&&t.subTasks.length>0?(c(),v("div",Xe,[l(J,{dense:"",class:"subtasks-list"},{default:a(()=>[(c(!0),v(M,null,P(t.subTasks,o=>(c(),T(z,{key:o.id,dense:"",class:"q-py-none"},{default:a(()=>[l(w,{avatar:"",class:"q-pr-none"},{default:a(()=>[l(W,{modelValue:o.completed,"onUpdate:modelValue":[n=>o.completed=n,n=>pe(t.createdAt,o.id)],onClick:e[4]||(e[4]=Qe(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(w,{class:qe({"text-strike":o.completed})},{default:a(()=>[l(A,{caption:""},{default:a(()=>[y(k(o.title),1)]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:2},1024)])):le("",!0)]),_:2},1032,["onClick"]),l(w,{side:""},{default:a(()=>[l(p,{flat:"",round:"",color:"secondary",icon:"edit",onClick:o=>N(t.createdAt)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):(c(),v("div",Ge,e[10]||(e[10]=[u("p",null,"沒有進行中的事項",-1)]))),e[14]||(e[14]=u("h5",{class:"q-my-md"},"已完成的事項",-1)),G.value.length>0?(c(),T(J,{key:2,separator:""},{default:a(()=>[(c(!0),v(M,null,P(G.value,t=>(c(),T(z,{key:t.id,clickable:"",class:"completed-task"},{default:a(()=>[l(w,{avatar:""},{default:a(()=>[l(W,{modelValue:t.completed,"onUpdate:modelValue":[o=>t.completed=o,o=>Y(t)]},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(w,{onClick:o=>N(t.createdAt)},{default:a(()=>[l(A,{class:"text-strike"},{default:a(()=>[y(k(t.title),1)]),_:2},1024),l(A,{caption:""},{default:a(()=>[y(k(t.description),1)]),_:2},1024),l(A,{caption:""},{default:a(()=>[y("完成於: "+k(t.completedAt),1)]),_:2},1024),t.inFlow?(c(),T(Ue,{key:0,color:"positive","text-color":"white",size:"sm"},{default:a(()=>e[11]||(e[11]=[y("心流")])),_:1})):le("",!0)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})):(c(),v("div",Ke,e[12]||(e[12]=[u("p",null,"沒有已完成的事項",-1)])))])]))]),_:1}),l(se,{modelValue:x.value,"onUpdate:modelValue":e[6]||(e[6]=t=>x.value=t),persistent:""},{default:a(()=>[l(H,{style:{"min-width":"500px"}},{default:a(()=>[l($,null,{default:a(()=>e[15]||(e[15]=[u("div",{class:"text-h6"},"批量輸入待辦事項",-1)])),_:1}),l($,null,{default:a(()=>[l(j,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=t=>g.value=t),type:"textarea",filled:"",autofocus:"",placeholder:"請輸入待辦事項清單，AI將自動分析主任務和子任務關係...",rows:"12",hint:`範例格式：
1. 完成專案報告
   - 整理數據
   - 撰寫摘要
2. 預約牙醫
   - 確認時間
   - 預先填寫表格`},null,8,["modelValue"])]),_:1}),l(oe,{align:"right"},{default:a(()=>[F(l(p,{flat:"",label:"取消",color:"grey"},null,512),[[O]]),l(p,{flat:"",label:"解析任務",color:"primary",loading:U.value,disable:!g.value.trim(),onClick:me},null,8,["loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(se,{modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=t=>D.value=t)},{default:a(()=>[l(H,null,{default:a(()=>[l($,null,{default:a(()=>e[16]||(e[16]=[u("div",{class:"text-h6"},"恭喜完成任務!",-1)])),_:1}),l($,null,{default:a(()=>e[17]||(e[17]=[u("p",null,"完成這項任務時，你是否處於心流狀態？",-1),u("p",{class:"text-caption"},"心流：高度專注，時間感消失，完全沉浸在任務中的狀態",-1)])),_:1}),l(oe,{align:"right"},{default:a(()=>[F(l(p,{flat:"",label:"否",color:"grey"},null,512),[[O]]),F(l(p,{flat:"",label:"是",color:"positive",onClick:ce},null,512),[[O]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(d,{onReuseResult:fe})]),_:1})}}},Tt=_e(Ye,[["__scopeId","data-v-dc8ee5f9"]]);export{Tt as default};
