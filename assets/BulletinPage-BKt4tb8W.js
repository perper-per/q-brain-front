import{i as J,r as $,a3 as K,a4 as L,a5 as W,o as G,j as X,a7 as Z,$ as ee,aI as te,a2 as T,M as ae,aJ as le,l as ne,w as oe,e as I,k as A,q as o,g as h,t as g,h as l,Q as w,z as U,y as Q,A as j,H as ie}from"./index-13tiM3sU.js";import{Q as E}from"./QInput-Hj4UqFwR.js";import{a as se}from"./QChip-C1colfmv.js";import{Q as F,a as ue,b as O}from"./QTable-BZekhemz.js";import{Q as M}from"./QTooltip-Da6KLzgy.js";import{Q as re}from"./QBtnGroup-D2eyrE1w.js";import{Q as z}from"./QCardSection-BriuI8Qv.js";import{d as de}from"./use-id-DEap90jY.js";import{Q as me}from"./QCard-D-eCJlwy.js";import{Q as ce}from"./QDialog-SccHfgtw.js";import{Q as pe}from"./QPage-6V52qkFZ.js";import{u as fe}from"./use-quasar-Qs8Sf9w6.js";import{d as C}from"./date-B8Vag278.js";import"./use-dark-uGKCEJOe.js";import"./private.use-form-C6urO06t.js";import"./QSeparator-D1Cn1S1H.js";import"./QVirtualScroll-DoppGZm_.js";import"./QList-DTyrWbNx.js";import"./rtl-DFPa-2ov.js";import"./QItem-VlR6gCfG.js";import"./QItemLabel-BlN4F6IF.js";import"./format-dCatN8Gn.js";import"./use-fullscreen-3AwtB14-.js";import"./use-timeout-BAvBZzMS.js";import"./use-prevent-scroll-xWtCFL8B.js";const be=J({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(y,{slots:r,emit:p}){const D=ee(),f=$(null);let c=0;const m=[];function i(n){const s=typeof n=="boolean"?n:y.noErrorFocus!==!0,b=++c,v=(u,d)=>{p(`validation${u===!0?"Success":"Error"}`,d)},Y=u=>{const d=u.validate();return typeof d.then=="function"?d.then(e=>({valid:e,comp:u}),e=>({valid:!1,comp:u,err:e})):Promise.resolve({valid:d,comp:u})};return(y.greedy===!0?Promise.all(m.map(Y)).then(u=>u.filter(d=>d.valid!==!0)):m.reduce((u,d)=>u.then(()=>Y(d).then(e=>{if(e.valid===!1)return Promise.reject(e)})),Promise.resolve()).catch(u=>[u])).then(u=>{if(u===void 0||u.length===0)return b===c&&v(!0),!0;if(b===c){const{comp:d,err:e}=u[0];if(e!==void 0&&console.error(e),v(!1,d),s===!0){const a=u.find(({comp:t})=>typeof t.focus=="function"&&te(t.$)===!1);a!==void 0&&a.comp.focus()}}return!1})}function k(){c++,m.forEach(n=>{typeof n.resetValidation=="function"&&n.resetValidation()})}function B(n){n!==void 0&&T(n);const s=c+1;i().then(b=>{s===c&&b===!0&&(y.onSubmit!==void 0?p("submit",n):n!==void 0&&n.target!==void 0&&typeof n.target.submit=="function"&&n.target.submit())})}function S(n){n!==void 0&&T(n),p("reset"),ae(()=>{k(),y.autofocus===!0&&y.noResetFocus!==!0&&V()})}function V(){de(()=>{if(f.value===null)return;const n=f.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||f.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||f.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(f.value.querySelectorAll("[tabindex]"),s=>s.tabIndex!==-1);n?.focus({preventScroll:!0})})}K(le,{bindComponent(n){m.push(n)},unbindComponent(n){const s=m.indexOf(n);s!==-1&&m.splice(s,1)}});let q=!1;return L(()=>{q=!0}),W(()=>{q===!0&&y.autofocus===!0&&V()}),G(()=>{y.autofocus===!0&&V()}),Object.assign(D.proxy,{validate:i,resetValidation:k,submit:B,reset:S,focus:V,getValidationComponents:()=>m}),()=>X("form",{class:"q-form",ref:f,onSubmit:B,onReset:S},Z(r.default))}}),ve={class:"row items-center justify-between q-mb-md"},ye={class:"text-h5"},ge={class:"text-h6"},De={class:"row q-col-gutter-md"},he={class:"col-6"},we={class:"col-6"},$e={class:"row justify-end q-mt-md"},Je={__name:"BulletinPage",setup(y){const{t:r}=ne(),p=fe(),{apiAuth:D}=ie(),f=$(!1),c=$([]),m=$(!1),i=$({type:"info",content:"",publishDate:"",expiryDate:"",status:"draft"}),k=[{name:"type",label:r("admin.bulletin.type"),field:"type",align:"left"},{name:"content",label:r("admin.bulletin.content"),field:"content",align:"left"},{name:"publishDate",label:r("admin.bulletin.publishDate"),field:"publishDate",format:e=>C.formatDate(e,"YYYY/MM/DD"),align:"left"},{name:"status",label:r("admin.bulletin.status"),field:"status",align:"left"},{name:"actions",label:r("admin.bulletin.actions"),field:"actions",align:"center"}],B=[{label:r("admin.bulletin.types.info"),value:"info"},{label:r("admin.bulletin.types.warning"),value:"warning"},{label:r("admin.bulletin.types.event"),value:"event"}],S=[{label:r("admin.bulletin.statuses.draft"),value:"draft"},{label:r("admin.bulletin.statuses.published"),value:"published"}],V=e=>({draft:"grey",published:"positive",expired:"negative"})[e]||"grey",q=e=>({info:"info",warning:"warning",event:"event"})[e]||"info",n=e=>({info:"info",warning:"warning",event:"primary"})[e]||"grey",s=$({sortBy:"publishDate",descending:!0,page:1,rowsPerPage:15,rowsNumber:0}),b=$(""),v=async e=>{const{page:a,rowsPerPage:t,sortBy:x,descending:H}=e.pagination;f.value=!0;try{const P={page:a,limit:t,sortBy:x,order:H?"desc":"asc",search:b.value},{data:_}=await D.get("/api/bulletins",{params:P});_?.items?(c.value=_.items.map(R=>({...R,id:R._id})),s.value.rowsNumber=_.total||0):(c.value=[],s.value.rowsNumber=0),s.value.page=a,s.value.rowsPerPage=t,console.log("Response data:",_)}catch(P){console.error("Error loading bulletins:",P),c.value=[],p.notify({type:"negative",message:P.response?.data?.message||"載入失敗",position:"top"})}finally{f.value=!1}};oe(b,()=>{s.value.page=1,v({pagination:s.value})}),G(()=>{v({pagination:s.value})});const Y=(e=null)=>{if(e){const a=e.publishDate?C.formatDate(e.publishDate,"YYYY-MM-DD"):"",t=e.expiryDate?C.formatDate(e.expiryDate,"YYYY-MM-DD"):"";i.value={...e,_id:e._id||e.id,publishDate:a,expiryDate:t}}else i.value={type:"info",content:"",publishDate:C.formatDate(Date.now(),"YYYY-MM-DD"),expiryDate:"",status:"draft"};m.value=!0,console.log("原始公告：",e)},N=async()=>{try{const e={...i.value};if(e.publishDate&&(e.publishDate=C.formatDate(e.publishDate,"YYYY-MM-DD")),e.expiryDate&&(e.expiryDate=C.formatDate(e.expiryDate,"YYYY-MM-DD")),i.value.id||i.value._id){const a=i.value._id||i.value.id;await D.patch(`/api/bulletins/${a}`,e)}else await D.post("/api/bulletins",e);m.value=!1,await v({pagination:s.value})}catch(e){console.error("Error saving bulletin:",e),p.notify({type:"negative",message:e.response?.data?.message||"儲存失敗",position:"top"})}},u=e=>{p.dialog({title:r("admin.bulletin.delete"),message:r("admin.bulletin.confirmDelete"),cancel:!0,persistent:!0}).onOk(async()=>{try{const a=e._id||e.id;await D.delete(`/api/bulletins/${a}`),await v({pagination:s.value})}catch(a){console.error("Error deleting bulletin:",a),p.notify({type:"negative",message:a.response?.data?.message||"刪除失敗",position:"top"})}})},d=async(e,a)=>{try{const t=e._id||e.id;await D.patch(`/api/bulletins/${t}`,{status:a}),p.notify({type:"positive",message:r(a==="published"?"admin.bulletin.publishSuccess":"admin.bulletin.unpublishSuccess"),position:"top"}),await v({pagination:s.value})}catch(t){console.error("Error changing bulletin status:",t),p.notify({type:"negative",message:t.response?.data?.message||"狀態更新失敗",position:"top"})}};return(e,a)=>(I(),A(pe,{class:"q-pa-md"},{default:o(()=>[h("div",ve,[h("div",ye,g(e.$t("admin.bulletin.title")),1),l(w,{color:"primary",label:e.$t("admin.bulletin.newBulletin"),onClick:a[0]||(a[0]=t=>Y()),icon:"add"},null,8,["label"])]),l(ue,{rows:c.value,columns:k,"row-key":"id",loading:f.value,pagination:s.value,onRequest:v,filter:b.value,"binary-state-sort":""},{"top-right":o(()=>[l(E,{borderless:"",dense:"",debounce:"300",modelValue:b.value,"onUpdate:modelValue":a[1]||(a[1]=t=>b.value=t),placeholder:"搜尋"},{append:o(()=>[l(U,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-status":o(t=>[l(F,{props:t},{default:o(()=>[l(se,{color:V(t.row.status),"text-color":"white",size:"sm"},{default:o(()=>[Q(g(e.$t(`admin.bulletin.statuses.${t.row.status}`)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-type":o(t=>[l(F,{props:t},{default:o(()=>[l(U,{name:q(t.row.type),color:n(t.row.type),size:"sm"},null,8,["name","color"]),Q(" "+g(e.$t(`admin.bulletin.types.${t.row.type}`)),1)]),_:2},1032,["props"])]),"body-cell-actions":o(t=>[l(F,{props:t},{default:o(()=>[l(re,{flat:""},{default:o(()=>[l(w,{flat:"",round:"",color:"primary",icon:"edit",onClick:x=>Y(t.row)},{default:o(()=>[l(M,null,{default:o(()=>[Q(g(e.$t("admin.bulletin.editBulletin")),1)]),_:1})]),_:2},1032,["onClick"]),t.row.status==="draft"?(I(),A(w,{key:0,flat:"",round:"",color:"positive",icon:"publish",onClick:x=>d(t.row,"published")},{default:o(()=>[l(M,null,{default:o(()=>[Q(g(e.$t("admin.bulletin.publish")),1)]),_:1})]),_:2},1032,["onClick"])):j("",!0),t.row.status==="published"?(I(),A(w,{key:1,flat:"",round:"",color:"grey",icon:"unpublished",onClick:x=>d(t.row,"draft")},{default:o(()=>[l(M,null,{default:o(()=>[Q(g(e.$t("admin.bulletin.unpublish")),1)]),_:1})]),_:2},1032,["onClick"])):j("",!0),l(w,{flat:"",round:"",color:"negative",icon:"delete",onClick:x=>u(t.row)},{default:o(()=>[l(M,null,{default:o(()=>[Q(g(e.$t("admin.bulletin.delete")),1)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","loading","pagination","filter"]),l(ce,{modelValue:m.value,"onUpdate:modelValue":a[8]||(a[8]=t=>m.value=t),persistent:""},{default:o(()=>[l(me,{style:{"min-width":"500px"}},{default:o(()=>[l(z,null,{default:o(()=>[h("div",ge,g(i.value.id?e.$t("admin.bulletin.editBulletin"):e.$t("admin.bulletin.newBulletin")),1)]),_:1}),l(z,null,{default:o(()=>[l(be,{onSubmit:N},{default:o(()=>[l(O,{modelValue:i.value.type,"onUpdate:modelValue":a[2]||(a[2]=t=>i.value.type=t),options:B,label:e.$t("admin.bulletin.type"),"emit-value":"","map-options":"",class:"q-mb-md"},null,8,["modelValue","label"]),l(O,{modelValue:i.value.status,"onUpdate:modelValue":a[3]||(a[3]=t=>i.value.status=t),options:S,label:e.$t("admin.bulletin.status"),"emit-value":"","map-options":"",class:"q-mb-md"},null,8,["modelValue","label"]),l(E,{modelValue:i.value.content,"onUpdate:modelValue":a[4]||(a[4]=t=>i.value.content=t),type:"textarea",label:e.$t("admin.bulletin.content"),rows:"4",class:"q-mb-md"},null,8,["modelValue","label"]),h("div",De,[h("div",he,[l(E,{modelValue:i.value.publishDate,"onUpdate:modelValue":a[5]||(a[5]=t=>i.value.publishDate=t),label:e.$t("admin.bulletin.publishDate"),type:"date"},null,8,["modelValue","label"])]),h("div",we,[l(E,{modelValue:i.value.expiryDate,"onUpdate:modelValue":a[6]||(a[6]=t=>i.value.expiryDate=t),label:e.$t("admin.bulletin.expiryDate"),type:"date"},null,8,["modelValue","label"])])]),h("div",$e,[l(w,{flat:"",label:e.$t("admin.bulletin.cancel"),onClick:a[7]||(a[7]=t=>m.value=!1),class:"q-mr-sm"},null,8,["label"]),l(w,{label:e.$t("admin.bulletin.save"),type:"submit",color:"primary"},null,8,["label"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{Je as default};
