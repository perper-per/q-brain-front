import{h as ve,ap as ke,aq as be,m as C,i as ge,a2 as _e,u as ye,ar as Te,r as w,T as Ae,as as he,o as we,G as xe,n as Ve,d as c,j as T,p as a,g as l,e as v,f as u,t as k,Q as p,F as M,A as P,x as _,O as Ce,J as Qe,z as le,B as F}from"./index-D6n0LQe6.js";import{Q as j}from"./QInput-DET5MchE.js";import{u as qe,Q as Ie,C as $e,f as V}from"./ContainerComp-CoeWnVaD.js";import{Q as z}from"./QCard-BT9qALh8.js";import{Q as W,a as Le}from"./QChip-DAjTpyIN.js";import{Q as H,a as A}from"./QItem-BGmdocP_.js";import{Q as h}from"./QItemLabel-BM5B07M1.js";import{Q as J}from"./QList-EaMWC3IA.js";import{Q as $}from"./QCardSection-eSsSUqqg.js";import{Q as oe}from"./QDialog-CgMlYIdH.js";import{Q as Se}from"./QPage-RUxdcysq.js";import{C as O}from"./ClosePopup-5vqEmYii.js";import{u as Ue}from"./axios-BrBl7GXC.js";import{u as De}from"./use-quasar-B5C4bfPT.js";import{_ as Ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-id-DeWnQr2H.js";import"./use-timeout-MiASM7Rb.js";import"./use-dark-DXycIuUe.js";import"./private.use-form-DYYpFveD.js";import"./QBtnDropdown-BmciKFBJ.js";import"./QBtnGroup-Gvj5GhpQ.js";import"./QTooltip-BnNxt8VP.js";import"./use-fullscreen-BApVUFjZ.js";import"./use-prevent-scroll-BYhdOUQE.js";const se=ve({name:"QCardActions",props:{...ke,vertical:Boolean},setup(L,{slots:r}){const Q=be(L),y=C(()=>`q-card__actions ${Q.value} q-card__actions--${L.vertical===!0?"vert column":"horiz row"}`);return()=>ge("div",{class:y.value},_e(r.default))}}),Be={key:0},Ee={class:"row justify-between items-center q-mb-md"},Re={key:0},Me={class:"row justify-end q-mt-md"},Pe={key:1},Fe={class:"row items-center justify-between"},je={class:"q-mb-md q-mt-md"},ze={class:"text-caption"},We=["innerHTML"],He={key:2,class:"text-center q-pa-lg"},Je={key:1},Oe={class:"row justify-between items-center q-mb-md"},Ge={key:0,class:"q-mt-xs"},Ke={key:1,class:"text-center q-pa-lg"},Xe={key:3,class:"text-center q-pa-lg"},Ye={__name:"TodoPage",setup(L){const r=qe(),Q=ye(),y=Te(),S=De(),{apiAuth:ae}=Ue(),x=w(!1),g=w(""),U=w(!1),D=w(!1),q=w(null),b=w(!1),f=Ae({title:"",description:"",content:""}),ne=C(()=>!!y.params.id),m=C(()=>y.params.id?r.value.find(o=>o.createdAt.toString()===y.params.id):null),G=C(()=>r.value.filter(o=>!o.completed)),K=C(()=>r.value.filter(o=>o.completed)),N=o=>{Q.push(`/site/todo/${o}`)},B=()=>{if(b.value){if(!confirm("有未保存的更改，確定要離開嗎？"))return;b.value=!1}Q.push("/site/todo")},ie=()=>{m.value&&(f.title=m.value.title,f.description=m.value.description,f.content=m.value.content,b.value=!0)},re=()=>{b.value=!1},de=()=>{if(!m.value)return;const o=r.value.findIndex(e=>e.createdAt.toString()===y.params.id);o!==-1&&(r.value[o]={...r.value[o],title:f.title,description:f.description,content:f.content,updatedAt:V(Date.now())},b.value=!1)},ue=()=>{if(m.value&&confirm("確定要刪除這個待辦事項嗎？")){const o=r.value.findIndex(e=>e.createdAt.toString()===y.params.id);o!==-1&&(r.value.splice(o,1),B())}},X=o=>{const e=r.value.findIndex(d=>d.createdAt===o.createdAt);e!==-1&&(r.value[e]={...r.value[e],completed:!0,completedAt:V(Date.now())},q.value=o.createdAt,D.value=!0)},Y=o=>{const e=r.value.findIndex(d=>d.createdAt===o.createdAt);e!==-1&&(r.value[e]={...r.value[e],completed:!1,completedAt:null,inFlow:!1})},ce=()=>{if(!q.value)return;const o=r.value.findIndex(e=>e.createdAt===q.value);o!==-1&&(r.value[o]={...r.value[o],inFlow:!0}),q.value=null},me=async()=>{if(g.value.trim()){U.value=!0;try{const o=g.value.trim(),{data:e}=await ae.post("/api/ai/analyze-tasks",{text:o});if(!e.success)throw new Error(e.message||"處理失敗");const d=e.result;let t;try{t=JSON.parse(d)}catch(n){return console.error("AI 返回的不是有效 JSON:",d,n),Z(o)}const s=Date.now();for(let n=0;n<t.length;n++){const i=t[n];i.subTasks&&i.subTasks.length>0&&(i.subTasks=i.subTasks.map(E=>({id:E.id||`${s}-${n}-${Math.random().toString(36).substring(2,9)}`,title:E.title,completed:!1}))),r.value.unshift({title:i.title,description:i.description||"",content:i.description||"",createdAt:s-n,updatedAt:V(s),completed:!1,subTasks:i.subTasks||[],order:n})}x.value=!1,g.value="",S.notify({color:"positive",message:"成功創建待辦事項",icon:"check"})}catch(o){console.error("AI 處理失敗:",o),S.notify({type:"negative",message:"無法處理待辦事項："+(o.response?.data?.message||o.message),position:"top"}),Z(g.value)}finally{U.value=!1}}},Z=o=>{const e=o.split(`
`).filter(n=>n.trim()),d=Date.now(),t=[];let s=null;for(let n=0;n<e.length;n++){const i=e[n].trim();if(!i)continue;if((i.startsWith("  ")||i.startsWith("	")||i.startsWith("- ")||i.startsWith("* ")||/^\d+\.\s/.test(i))&&s){const I=i.replace(/^[\s\t]+/,"").replace(/^[-*]\s+/,"").replace(/^\d+\.\s+/,"");s.subTasks||(s.subTasks=[]),s.subTasks.push({id:`${d}-${n}-${Math.random().toString(36).substring(2,9)}`,title:I,completed:!1})}else{let I=i,R="";if(i.includes(":")){const te=i.split(":");I=te[0].trim(),R=te.slice(1).join(":").trim()}s={title:I,description:R,content:R,createdAt:d-n,updatedAt:V(d),completed:!1,subTasks:[]},t.push(s)}}t.forEach((n,i)=>{r.value.unshift({...n,order:i})}),x.value=!1,g.value=""};he((o,e,d)=>{b.value?confirm("有未保存的更改，確定要離開嗎？")?(b.value=!1,d()):d(!1):d()});const ee=o=>{if(b.value){const e="有未保存的更改，確定要離開嗎？";return o.returnValue=e,e}};we(()=>{window.addEventListener("beforeunload",ee)}),xe(()=>{window.removeEventListener("beforeunload",ee)});const pe=(o,e)=>{const d=r.value.findIndex(i=>i.createdAt===o);if(d===-1)return;const t=r.value[d];if(!t.subTasks)return;const s=t.subTasks.findIndex(i=>i.id===e);if(s===-1)return;t.subTasks[s].completed=!t.subTasks[s].completed;const n=t.subTasks.every(i=>i.completed);n&&!t.completed?X(t):!n&&t.completed&&Y(t)},fe=o=>{try{const e=JSON.parse(o.outputResult),d=Date.now();for(let t=0;t<e.length;t++){const s=e[t];s.subTasks&&s.subTasks.length>0&&(s.subTasks=s.subTasks.map(n=>({id:n.id||`${d}-${t}-${Math.random().toString(36).substring(2,9)}`,title:n.title,completed:!1}))),r.value.unshift({title:s.title,description:s.description||"",content:s.description||"",createdAt:d-t,updatedAt:V(d),completed:!1,subTasks:s.subTasks||[],order:t})}}catch(e){console.error("處理歷史記錄失敗:",e),S.notify({color:"negative",message:"無法使用此記錄",icon:"error"})}};return(o,e)=>{const d=Ve("AIHistoryList");return c(),T(Se,{padding:""},{default:a(()=>[l($e,null,{default:a(()=>[ne.value?(c(),v("div",Be,[u("div",Ee,[u("h3",null,k(m.value?.title||"待辦詳情"),1),l(p,{color:"primary",icon:"arrow_back",label:"返回",onClick:B})]),b.value&&m.value?(c(),v("div",Re,[l(j,{class:"q-mb-md",modelValue:f.title,"onUpdate:modelValue":e[0]||(e[0]=t=>f.title=t),label:"標題",outlined:""},null,8,["modelValue"]),l(j,{class:"q-mb-md",modelValue:f.description,"onUpdate:modelValue":e[1]||(e[1]=t=>f.description=t),label:"描述",outlined:""},null,8,["modelValue"]),l(z,{flat:"",bordered:"",class:"q-mt-sm"},{default:a(()=>[l(Ie,{modelValue:f.content,"onUpdate:modelValue":e[2]||(e[2]=t=>f.content=t),"min-height":"5rem"},null,8,["modelValue"])]),_:1}),u("div",Me,[l(p,{color:"grey",label:"取消",onClick:re,class:"q-mr-sm"}),l(p,{color:"primary",label:"保存",onClick:de})])])):m.value?(c(),v("div",Pe,[u("div",Fe,[u("h3",je,k(m.value.title),1),u("div",null,[l(p,{round:"",color:"secondary",icon:"edit",onClick:ie}),l(p,{class:"q-ml-sm",round:"",color:"red",icon:"delete",onClick:ue})])]),u("div",null,k(m.value.description),1),u("div",ze,"更新時間："+k(m.value.updatedAt),1),u("div",{class:"q-mt-md",innerHTML:m.value.content},null,8,We)])):(c(),v("div",He,[e[8]||(e[8]=u("p",null,"找不到對應的待辦事項",-1)),l(p,{color:"primary",label:"返回列表",onClick:B})]))])):(c(),v("div",Je,[u("div",Oe,[e[9]||(e[9]=u("h3",null,"我的待辦事項",-1)),u("div",null,[l(p,{color:"primary",icon:"add",label:"新增待辦",to:"/site/todo-new",class:"q-mr-sm"}),l(p,{color:"secondary",icon:"text_snippet",label:"批量輸入",onClick:e[3]||(e[3]=t=>x.value=!0)})])]),u("div",null,[e[13]||(e[13]=u("h5",{class:"q-my-md"},"進行中的事項",-1)),G.value.length>0?(c(),T(J,{key:0,separator:""},{default:a(()=>[(c(!0),v(M,null,P(G.value,t=>(c(),T(H,{key:t.id,clickable:""},{default:a(()=>[l(A,{avatar:""},{default:a(()=>[l(W,{modelValue:t.completed,"onUpdate:modelValue":[s=>t.completed=s,s=>X(t)]},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(A,{onClick:s=>N(t.createdAt)},{default:a(()=>[l(h,null,{default:a(()=>[_(k(t.title),1)]),_:2},1024),l(h,{caption:""},{default:a(()=>[_(k(t.description),1)]),_:2},1024),l(h,{caption:""},{default:a(()=>[_(k(t.updatedAt),1)]),_:2},1024),t.subTasks&&t.subTasks.length>0?(c(),v("div",Ge,[l(J,{dense:"",class:"subtasks-list"},{default:a(()=>[(c(!0),v(M,null,P(t.subTasks,s=>(c(),T(H,{key:s.id,dense:"",class:"q-py-none"},{default:a(()=>[l(A,{avatar:"",class:"q-pr-none"},{default:a(()=>[l(W,{modelValue:s.completed,"onUpdate:modelValue":[n=>s.completed=n,n=>pe(t.createdAt,s.id)],onClick:e[4]||(e[4]=Ce(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(A,{class:Qe({"text-strike":s.completed})},{default:a(()=>[l(h,{caption:""},{default:a(()=>[_(k(s.title),1)]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:2},1024)])):le("",!0)]),_:2},1032,["onClick"]),l(A,{side:""},{default:a(()=>[l(p,{flat:"",round:"",color:"secondary",icon:"edit",onClick:s=>N(t.createdAt)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):(c(),v("div",Ke,e[10]||(e[10]=[u("p",null,"沒有進行中的事項",-1)]))),e[14]||(e[14]=u("h5",{class:"q-my-md"},"已完成的事項",-1)),K.value.length>0?(c(),T(J,{key:2,separator:""},{default:a(()=>[(c(!0),v(M,null,P(K.value,t=>(c(),T(H,{key:t.id,clickable:"",class:"completed-task"},{default:a(()=>[l(A,{avatar:""},{default:a(()=>[l(W,{modelValue:t.completed,"onUpdate:modelValue":[s=>t.completed=s,s=>Y(t)]},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(A,{onClick:s=>N(t.createdAt)},{default:a(()=>[l(h,{class:"text-strike"},{default:a(()=>[_(k(t.title),1)]),_:2},1024),l(h,{caption:""},{default:a(()=>[_(k(t.description),1)]),_:2},1024),l(h,{caption:""},{default:a(()=>[_("完成於: "+k(t.completedAt),1)]),_:2},1024),t.inFlow?(c(),T(Le,{key:0,color:"positive","text-color":"white",size:"sm"},{default:a(()=>e[11]||(e[11]=[_("心流")])),_:1})):le("",!0)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})):(c(),v("div",Xe,e[12]||(e[12]=[u("p",null,"沒有已完成的事項",-1)])))])]))]),_:1}),l(oe,{modelValue:x.value,"onUpdate:modelValue":e[6]||(e[6]=t=>x.value=t),persistent:""},{default:a(()=>[l(z,{style:{"min-width":"500px"}},{default:a(()=>[l($,null,{default:a(()=>e[15]||(e[15]=[u("div",{class:"text-h6"},"批量輸入待辦事項",-1)])),_:1}),l($,null,{default:a(()=>[l(j,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=t=>g.value=t),type:"textarea",filled:"",autofocus:"",placeholder:"請輸入待辦事項清單，AI將自動分析主任務和子任務關係...",rows:"12",hint:`範例格式：
1. 完成專案報告
   - 整理數據
   - 撰寫摘要
2. 預約牙醫
   - 確認時間
   - 預先填寫表格`},null,8,["modelValue"])]),_:1}),l(se,{align:"right"},{default:a(()=>[F(l(p,{flat:"",label:"取消",color:"grey"},null,512),[[O]]),l(p,{flat:"",label:"解析任務",color:"primary",loading:U.value,disable:!g.value.trim(),onClick:me},null,8,["loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(oe,{modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=t=>D.value=t)},{default:a(()=>[l(z,null,{default:a(()=>[l($,null,{default:a(()=>e[16]||(e[16]=[u("div",{class:"text-h6"},"恭喜完成任務!",-1)])),_:1}),l($,null,{default:a(()=>e[17]||(e[17]=[u("p",null,"完成這項任務時，你是否處於心流狀態？",-1),u("p",{class:"text-caption"},"心流：高度專注，時間感消失，完全沉浸在任務中的狀態",-1)])),_:1}),l(se,{align:"right"},{default:a(()=>[F(l(p,{flat:"",label:"否",color:"grey"},null,512),[[O]]),F(l(p,{flat:"",label:"是",color:"positive",onClick:ce},null,512),[[O]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(d,{onReuseResult:fe})]),_:1})}}},ht=Ne(Ye,[["__scopeId","data-v-dc8ee5f9"]]);export{ht as default};
