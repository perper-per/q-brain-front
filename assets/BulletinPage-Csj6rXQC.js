import{h as j,r as v,_ as M,$ as O,a0 as z,o as U,i as G,a2 as H,W as K,aC as W,Z as Y,H as Z,aD as J,k as L,w as X,d as ee,j as te,p as i,f as b,t as h,g as n,Q as $,y as A,x as P}from"./index-30qSeABU.js";import{Q as k}from"./QInput-N7K_U6rL.js";import{a as ae}from"./QChip-BAohkfUn.js";import{Q as E,a as le,b as ne}from"./QTable-B76VzqbI.js";import{Q as R}from"./QTooltip-Crnp14uj.js";import{Q as oe}from"./QBtnGroup-DDTr2A0u.js";import{Q as T}from"./QCardSection-BSQgwcyL.js";import{d as ie}from"./use-id-bLJet6j2.js";import{Q as se}from"./QCard-ZMFdNZOO.js";import{Q as re}from"./QDialog-CuQNJvzG.js";import{Q as ue}from"./QPage-BUdFJ84u.js";import{u as de}from"./use-quasar-DTC_2SS4.js";import{d as N}from"./date-BMLy2WZX.js";import{u as me}from"./axios-BuZCFwUN.js";import"./use-dark-CmVSjrkD.js";import"./private.use-form-DLJhsYml.js";import"./QSeparator-kb6w-Ul-.js";import"./QVirtualScroll-BMx8sCQG.js";import"./QList-CVBaRoCp.js";import"./rtl-DFPa-2ov.js";import"./QItem-h6Bgg0_H.js";import"./QItemLabel-BsnJuEFs.js";import"./format-dCatN8Gn.js";import"./use-fullscreen-BkWi5qt_.js";import"./use-timeout-DY07DAU_.js";import"./use-prevent-scroll-VopiVRaM.js";const ce=j({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(f,{slots:u,emit:p}){const y=K(),m=v(null);let d=0;const r=[];function o(l){const s=typeof l=="boolean"?l:f.noErrorFocus!==!0,c=++d,D=(e,t)=>{p(`validation${e===!0?"Success":"Error"}`,t)},x=e=>{const t=e.validate();return typeof t.then=="function"?t.then(a=>({valid:a,comp:e}),a=>({valid:!1,comp:e,err:a})):Promise.resolve({valid:t,comp:e})};return(f.greedy===!0?Promise.all(r.map(x)).then(e=>e.filter(t=>t.valid!==!0)):r.reduce((e,t)=>e.then(()=>x(t).then(a=>{if(a.valid===!1)return Promise.reject(a)})),Promise.resolve()).catch(e=>[e])).then(e=>{if(e===void 0||e.length===0)return c===d&&D(!0),!0;if(c===d){const{comp:t,err:a}=e[0];if(a!==void 0&&console.error(a),D(!1,t),s===!0){const w=e.find(({comp:S})=>typeof S.focus=="function"&&W(S.$)===!1);w!==void 0&&w.comp.focus()}}return!1})}function Q(){d++,r.forEach(l=>{typeof l.resetValidation=="function"&&l.resetValidation()})}function V(l){l!==void 0&&Y(l);const s=d+1;o().then(c=>{s===d&&c===!0&&(f.onSubmit!==void 0?p("submit",l):l!==void 0&&l.target!==void 0&&typeof l.target.submit=="function"&&l.target.submit())})}function C(l){l!==void 0&&Y(l),p("reset"),Z(()=>{Q(),f.autofocus===!0&&f.noResetFocus!==!0&&g()})}function g(){ie(()=>{if(m.value===null)return;const l=m.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||m.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||m.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(m.value.querySelectorAll("[tabindex]"),s=>s.tabIndex!==-1);l?.focus({preventScroll:!0})})}M(J,{bindComponent(l){r.push(l)},unbindComponent(l){const s=r.indexOf(l);s!==-1&&r.splice(s,1)}});let B=!1;return O(()=>{B=!0}),z(()=>{B===!0&&f.autofocus===!0&&g()}),U(()=>{f.autofocus===!0&&g()}),Object.assign(y.proxy,{validate:o,resetValidation:Q,submit:V,reset:C,focus:g,getValidationComponents:()=>r}),()=>G("form",{class:"q-form",ref:m,onSubmit:V,onReset:C},H(u.default))}}),fe={class:"row items-center justify-between q-mb-md"},pe={class:"text-h5"},be={class:"text-h6"},ve={class:"row q-col-gutter-md"},ye={class:"col-6"},ge={class:"col-6"},we={class:"row justify-end q-mt-md"},Ge={__name:"BulletinPage",setup(f){const{t:u}=L(),p=de(),{apiAuth:y}=me(),m=v(!1),d=v([]),r=v(!1),o=v({type:"info",content:"",publishDate:"",expiryDate:"",status:"draft"}),Q=[{name:"type",label:u("admin.bulletin.type"),field:"type",align:"left"},{name:"content",label:u("admin.bulletin.content"),field:"content",align:"left"},{name:"publishDate",label:u("admin.bulletin.publishDate"),field:"publishDate",format:e=>N.formatDate(e,"YYYY/MM/DD"),align:"left"},{name:"status",label:u("admin.bulletin.status"),field:"status",align:"left"},{name:"actions",label:u("admin.bulletin.actions"),field:"actions",align:"center"}],V=[{label:u("admin.bulletin.types.info"),value:"info"},{label:u("admin.bulletin.types.warning"),value:"warning"},{label:u("admin.bulletin.types.event"),value:"event"}],C=e=>({draft:"grey",published:"positive",expired:"negative"})[e]||"grey",g=e=>({info:"info",warning:"warning",event:"event"})[e]||"info",B=e=>({info:"info",warning:"warning",event:"primary"})[e]||"grey",l=v({sortBy:"publishDate",descending:!0,page:1,rowsPerPage:15,rowsNumber:0}),s=v(""),c=async e=>{const{page:t,rowsPerPage:a,sortBy:w,descending:S}=e.pagination;m.value=!0;try{const _={page:t,limit:a,sortBy:w,order:S?"desc":"asc",search:s.value},{data:q}=await y.get("/api/bulletins",{params:_});q?.items?(d.value=q.items.map(F=>({...F,id:F._id})),l.value.rowsNumber=q.total||0):(d.value=[],l.value.rowsNumber=0),l.value.page=t,l.value.rowsPerPage=a,console.log("Response data:",q)}catch(_){console.error("Error loading bulletins:",_),d.value=[],p.notify({type:"negative",message:_.response?.data?.message||"載入失敗",position:"top"})}finally{m.value=!1}};X(s,()=>{l.value.page=1,c({pagination:l.value})}),U(()=>{c({pagination:l.value})});const D=(e=null)=>{e?o.value={...e,_id:e._id||e.id}:o.value={type:"info",content:"",publishDate:N.formatDate(Date.now(),"YYYY-MM-DD"),expiryDate:"",status:"draft"},r.value=!0},x=async()=>{try{if(o.value.id||o.value._id){const e=o.value._id||o.value.id;await y.patch(`/api/bulletins/${e}`,o.value)}else await y.post("/api/bulletins",o.value);r.value=!1,await c({pagination:l.value})}catch(e){console.error("Error saving bulletin:",e),p.notify({type:"negative",message:e.response?.data?.message||"儲存失敗",position:"top"})}},I=e=>{p.dialog({title:u("admin.bulletin.delete"),message:u("admin.bulletin.confirmDelete"),cancel:!0,persistent:!0}).onOk(async()=>{try{const t=e._id||e.id;await y.delete(`/api/bulletins/${t}`),await c({pagination:l.value})}catch(t){console.error("Error deleting bulletin:",t),p.notify({type:"negative",message:t.response?.data?.message||"刪除失敗",position:"top"})}})};return(e,t)=>(ee(),te(ue,{class:"q-pa-md"},{default:i(()=>[b("div",fe,[b("div",pe,h(e.$t("admin.bulletin.title")),1),n($,{color:"primary",label:e.$t("admin.bulletin.newBulletin"),onClick:t[0]||(t[0]=a=>D()),icon:"add"},null,8,["label"])]),n(le,{rows:d.value,columns:Q,"row-key":"id",loading:m.value,pagination:l.value,onRequest:c,filter:s.value,"binary-state-sort":""},{"top-right":i(()=>[n(k,{borderless:"",dense:"",debounce:"300",modelValue:s.value,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value=a),placeholder:"搜尋"},{append:i(()=>[n(A,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-status":i(a=>[n(E,{props:a},{default:i(()=>[n(ae,{color:C(a.row.status),"text-color":"white",size:"sm"},{default:i(()=>[P(h(e.$t(`admin.bulletin.statuses.${a.row.status}`)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-type":i(a=>[n(E,{props:a},{default:i(()=>[n(A,{name:g(a.row.type),color:B(a.row.type),size:"sm"},null,8,["name","color"]),P(" "+h(e.$t(`admin.bulletin.types.${a.row.type}`)),1)]),_:2},1032,["props"])]),"body-cell-actions":i(a=>[n(E,{props:a},{default:i(()=>[n(oe,{flat:""},{default:i(()=>[n($,{flat:"",round:"",color:"primary",icon:"edit",onClick:w=>D(a.row)},{default:i(()=>[n(R,null,{default:i(()=>[P(h(e.$t("admin.bulletin.editBulletin")),1)]),_:1})]),_:2},1032,["onClick"]),n($,{flat:"",round:"",color:"negative",icon:"delete",onClick:w=>I(a.row)},{default:i(()=>[n(R,null,{default:i(()=>[P(h(e.$t("admin.bulletin.delete")),1)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows","loading","pagination","filter"]),n(re,{modelValue:r.value,"onUpdate:modelValue":t[7]||(t[7]=a=>r.value=a),persistent:""},{default:i(()=>[n(se,{style:{"min-width":"500px"}},{default:i(()=>[n(T,null,{default:i(()=>[b("div",be,h(o.value.id?e.$t("admin.bulletin.editBulletin"):e.$t("admin.bulletin.newBulletin")),1)]),_:1}),n(T,null,{default:i(()=>[n(ce,{onSubmit:x},{default:i(()=>[n(ne,{modelValue:o.value.type,"onUpdate:modelValue":t[2]||(t[2]=a=>o.value.type=a),options:V,label:e.$t("admin.bulletin.type"),"emit-value":"","map-options":"",class:"q-mb-md"},null,8,["modelValue","label"]),n(k,{modelValue:o.value.content,"onUpdate:modelValue":t[3]||(t[3]=a=>o.value.content=a),type:"textarea",label:e.$t("admin.bulletin.content"),rows:"4",class:"q-mb-md"},null,8,["modelValue","label"]),b("div",ve,[b("div",ye,[n(k,{modelValue:o.value.publishDate,"onUpdate:modelValue":t[4]||(t[4]=a=>o.value.publishDate=a),label:e.$t("admin.bulletin.publishDate"),type:"date"},null,8,["modelValue","label"])]),b("div",ge,[n(k,{modelValue:o.value.expiryDate,"onUpdate:modelValue":t[5]||(t[5]=a=>o.value.expiryDate=a),label:e.$t("admin.bulletin.expiryDate"),type:"date"},null,8,["modelValue","label"])])]),b("div",we,[n($,{flat:"",label:e.$t("admin.bulletin.cancel"),onClick:t[6]||(t[6]=a=>r.value=!1),class:"q-mr-sm"},null,8,["label"]),n($,{label:e.$t("admin.bulletin.save"),type:"submit",color:"primary"},null,8,["label"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{Ge as default};
